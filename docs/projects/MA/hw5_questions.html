<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joshua Chen">
<meta name="dcterms.date" content="2024-06-07">

<title>Joshua’s Website - Segmentation Methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>



<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Joshua’s Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../hobbies.html"> 
<span class="menu-text">Hobbies</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#k-means" id="toc-k-means" class="nav-link" data-scroll-target="#k-means">K-Means</a>
  <ul class="collapse">
  <li><a href="#data-description" id="toc-data-description" class="nav-link" data-scroll-target="#data-description">Data Description</a></li>
  <li><a href="#k-means-implementation" id="toc-k-means-implementation" class="nav-link" data-scroll-target="#k-means-implementation">K-Means Implementation</a></li>
  <li><a href="#comparing-with-sklearn-k-means" id="toc-comparing-with-sklearn-k-means" class="nav-link" data-scroll-target="#comparing-with-sklearn-k-means">Comparing with Sklearn K-Means</a></li>
  <li><a href="#within---cluster-sum-of-squares-and-silhouette-scores" id="toc-within---cluster-sum-of-squares-and-silhouette-scores" class="nav-link" data-scroll-target="#within---cluster-sum-of-squares-and-silhouette-scores">Within - Cluster Sum of Squares and Silhouette Scores</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#latent-class-mnl" id="toc-latent-class-mnl" class="nav-link" data-scroll-target="#latent-class-mnl">Latent-Class MNL</a>
  <ul class="collapse">
  <li><a href="#likelihood-for-the-latent-class-multi-nomial-logit-lc-mnl-model" id="toc-likelihood-for-the-latent-class-multi-nomial-logit-lc-mnl-model" class="nav-link" data-scroll-target="#likelihood-for-the-latent-class-multi-nomial-logit-lc-mnl-model">Likelihood for the Latent Class Multi-nomial Logit (LC-MNL) Model</a></li>
  <li><a href="#comparing-to-original-mnl" id="toc-comparing-to-original-mnl" class="nav-link" data-scroll-target="#comparing-to-original-mnl">Comparing to Original MNL</a></li>
  <li><a href="#number-of-class" id="toc-number-of-class" class="nav-link" data-scroll-target="#number-of-class">Number of Class</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Segmentation Methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Joshua Chen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 7, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this study, I employ clustering to identify natural groupings in the Iris dataset by utilizing the KMeans algorithm. This method reveals distinct clusters that share similar characteristics, helping us understand the inherent structure of the data. Subsequently, I will apply a Latent Class Multinomial Logit model on the Yogurt Dataset to delve deeper into the decision-making processes within these cluster groups, capturing the diverse preferences and behaviors across the dataset.</p>
</section>
<section id="k-means" class="level2">
<h2 class="anchored" data-anchor-id="k-means">K-Means</h2>
<section id="data-description" class="level3">
<h3 class="anchored" data-anchor-id="data-description">Data Description</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Iris Data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div id="49466e99" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<table id="itables_57f4032b_97aa_45de_b876_d442c8d77f25" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      
      <th>Sepal.Length</th>
      <th>Sepal.Width</th>
      <th>Petal.Length</th>
      <th>Petal.Width</th>
      <th>Species</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<div style="float:left; margin-right: 10px;">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
</div>
<div>
Loading ITables v2.1.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</div></td>

</tr></tbody>

</table>
<link href="https://www.unpkg.com/dt_for_itables@2.0.7/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.0.7/dt_bundle.js';

    document.querySelectorAll("#itables_57f4032b_97aa_45de_b876_d442c8d77f25:not(.dataTable)").forEach(table => {
        // Define the table data
        const data = [[5.1, 3.5, 1.4, 0.2, "setosa"], [4.9, 3.0, 1.4, 0.2, "setosa"], [4.7, 3.2, 1.3, 0.2, "setosa"], [4.6, 3.1, 1.5, 0.2, "setosa"], [5.0, 3.6, 1.4, 0.2, "setosa"], [5.4, 3.9, 1.7, 0.4, "setosa"], [4.6, 3.4, 1.4, 0.3, "setosa"], [5.0, 3.4, 1.5, 0.2, "setosa"], [4.4, 2.9, 1.4, 0.2, "setosa"], [4.9, 3.1, 1.5, 0.1, "setosa"], [5.4, 3.7, 1.5, 0.2, "setosa"], [4.8, 3.4, 1.6, 0.2, "setosa"], [4.8, 3.0, 1.4, 0.1, "setosa"], [4.3, 3.0, 1.1, 0.1, "setosa"], [5.8, 4.0, 1.2, 0.2, "setosa"], [5.7, 4.4, 1.5, 0.4, "setosa"], [5.4, 3.9, 1.3, 0.4, "setosa"], [5.1, 3.5, 1.4, 0.3, "setosa"], [5.7, 3.8, 1.7, 0.3, "setosa"], [5.1, 3.8, 1.5, 0.3, "setosa"], [5.4, 3.4, 1.7, 0.2, "setosa"], [5.1, 3.7, 1.5, 0.4, "setosa"], [4.6, 3.6, 1.0, 0.2, "setosa"], [5.1, 3.3, 1.7, 0.5, "setosa"], [4.8, 3.4, 1.9, 0.2, "setosa"], [5.0, 3.0, 1.6, 0.2, "setosa"], [5.0, 3.4, 1.6, 0.4, "setosa"], [5.2, 3.5, 1.5, 0.2, "setosa"], [5.2, 3.4, 1.4, 0.2, "setosa"], [4.7, 3.2, 1.6, 0.2, "setosa"], [4.8, 3.1, 1.6, 0.2, "setosa"], [5.4, 3.4, 1.5, 0.4, "setosa"], [5.2, 4.1, 1.5, 0.1, "setosa"], [5.5, 4.2, 1.4, 0.2, "setosa"], [4.9, 3.1, 1.5, 0.2, "setosa"], [5.0, 3.2, 1.2, 0.2, "setosa"], [5.5, 3.5, 1.3, 0.2, "setosa"], [4.9, 3.6, 1.4, 0.1, "setosa"], [4.4, 3.0, 1.3, 0.2, "setosa"], [5.1, 3.4, 1.5, 0.2, "setosa"], [5.0, 3.5, 1.3, 0.3, "setosa"], [4.5, 2.3, 1.3, 0.3, "setosa"], [4.4, 3.2, 1.3, 0.2, "setosa"], [5.0, 3.5, 1.6, 0.6, "setosa"], [5.1, 3.8, 1.9, 0.4, "setosa"], [4.8, 3.0, 1.4, 0.3, "setosa"], [5.1, 3.8, 1.6, 0.2, "setosa"], [4.6, 3.2, 1.4, 0.2, "setosa"], [5.3, 3.7, 1.5, 0.2, "setosa"], [5.0, 3.3, 1.4, 0.2, "setosa"], [7.0, 3.2, 4.7, 1.4, "versicolor"], [6.4, 3.2, 4.5, 1.5, "versicolor"], [6.9, 3.1, 4.9, 1.5, "versicolor"], [5.5, 2.3, 4.0, 1.3, "versicolor"], [6.5, 2.8, 4.6, 1.5, "versicolor"], [5.7, 2.8, 4.5, 1.3, "versicolor"], [6.3, 3.3, 4.7, 1.6, "versicolor"], [4.9, 2.4, 3.3, 1.0, "versicolor"], [6.6, 2.9, 4.6, 1.3, "versicolor"], [5.2, 2.7, 3.9, 1.4, "versicolor"], [5.0, 2.0, 3.5, 1.0, "versicolor"], [5.9, 3.0, 4.2, 1.5, "versicolor"], [6.0, 2.2, 4.0, 1.0, "versicolor"], [6.1, 2.9, 4.7, 1.4, "versicolor"], [5.6, 2.9, 3.6, 1.3, "versicolor"], [6.7, 3.1, 4.4, 1.4, "versicolor"], [5.6, 3.0, 4.5, 1.5, "versicolor"], [5.8, 2.7, 4.1, 1.0, "versicolor"], [6.2, 2.2, 4.5, 1.5, "versicolor"], [5.6, 2.5, 3.9, 1.1, "versicolor"], [5.9, 3.2, 4.8, 1.8, "versicolor"], [6.1, 2.8, 4.0, 1.3, "versicolor"], [6.3, 2.5, 4.9, 1.5, "versicolor"], [6.1, 2.8, 4.7, 1.2, "versicolor"], [6.4, 2.9, 4.3, 1.3, "versicolor"], [6.6, 3.0, 4.4, 1.4, "versicolor"], [6.8, 2.8, 4.8, 1.4, "versicolor"], [6.7, 3.0, 5.0, 1.7, "versicolor"], [6.0, 2.9, 4.5, 1.5, "versicolor"], [5.7, 2.6, 3.5, 1.0, "versicolor"], [5.5, 2.4, 3.8, 1.1, "versicolor"], [5.5, 2.4, 3.7, 1.0, "versicolor"], [5.8, 2.7, 3.9, 1.2, "versicolor"], [6.0, 2.7, 5.1, 1.6, "versicolor"], [5.4, 3.0, 4.5, 1.5, "versicolor"], [6.0, 3.4, 4.5, 1.6, "versicolor"], [6.7, 3.1, 4.7, 1.5, "versicolor"], [6.3, 2.3, 4.4, 1.3, "versicolor"], [5.6, 3.0, 4.1, 1.3, "versicolor"], [5.5, 2.5, 4.0, 1.3, "versicolor"], [5.5, 2.6, 4.4, 1.2, "versicolor"], [6.1, 3.0, 4.6, 1.4, "versicolor"], [5.8, 2.6, 4.0, 1.2, "versicolor"], [5.0, 2.3, 3.3, 1.0, "versicolor"], [5.6, 2.7, 4.2, 1.3, "versicolor"], [5.7, 3.0, 4.2, 1.2, "versicolor"], [5.7, 2.9, 4.2, 1.3, "versicolor"], [6.2, 2.9, 4.3, 1.3, "versicolor"], [5.1, 2.5, 3.0, 1.1, "versicolor"], [5.7, 2.8, 4.1, 1.3, "versicolor"], [6.3, 3.3, 6.0, 2.5, "virginica"], [5.8, 2.7, 5.1, 1.9, "virginica"], [7.1, 3.0, 5.9, 2.1, "virginica"], [6.3, 2.9, 5.6, 1.8, "virginica"], [6.5, 3.0, 5.8, 2.2, "virginica"], [7.6, 3.0, 6.6, 2.1, "virginica"], [4.9, 2.5, 4.5, 1.7, "virginica"], [7.3, 2.9, 6.3, 1.8, "virginica"], [6.7, 2.5, 5.8, 1.8, "virginica"], [7.2, 3.6, 6.1, 2.5, "virginica"], [6.5, 3.2, 5.1, 2.0, "virginica"], [6.4, 2.7, 5.3, 1.9, "virginica"], [6.8, 3.0, 5.5, 2.1, "virginica"], [5.7, 2.5, 5.0, 2.0, "virginica"], [5.8, 2.8, 5.1, 2.4, "virginica"], [6.4, 3.2, 5.3, 2.3, "virginica"], [6.5, 3.0, 5.5, 1.8, "virginica"], [7.7, 3.8, 6.7, 2.2, "virginica"], [7.7, 2.6, 6.9, 2.3, "virginica"], [6.0, 2.2, 5.0, 1.5, "virginica"], [6.9, 3.2, 5.7, 2.3, "virginica"], [5.6, 2.8, 4.9, 2.0, "virginica"], [7.7, 2.8, 6.7, 2.0, "virginica"], [6.3, 2.7, 4.9, 1.8, "virginica"], [6.7, 3.3, 5.7, 2.1, "virginica"], [7.2, 3.2, 6.0, 1.8, "virginica"], [6.2, 2.8, 4.8, 1.8, "virginica"], [6.1, 3.0, 4.9, 1.8, "virginica"], [6.4, 2.8, 5.6, 2.1, "virginica"], [7.2, 3.0, 5.8, 1.6, "virginica"], [7.4, 2.8, 6.1, 1.9, "virginica"], [7.9, 3.8, 6.4, 2.0, "virginica"], [6.4, 2.8, 5.6, 2.2, "virginica"], [6.3, 2.8, 5.1, 1.5, "virginica"], [6.1, 2.6, 5.6, 1.4, "virginica"], [7.7, 3.0, 6.1, 2.3, "virginica"], [6.3, 3.4, 5.6, 2.4, "virginica"], [6.4, 3.1, 5.5, 1.8, "virginica"], [6.0, 3.0, 4.8, 1.8, "virginica"], [6.9, 3.1, 5.4, 2.1, "virginica"], [6.7, 3.1, 5.6, 2.4, "virginica"], [6.9, 3.1, 5.1, 2.3, "virginica"], [5.8, 2.7, 5.1, 1.9, "virginica"], [6.8, 3.2, 5.9, 2.3, "virginica"], [6.7, 3.3, 5.7, 2.5, "virginica"], [6.7, 3.0, 5.2, 2.3, "virginica"], [6.3, 2.5, 5.0, 1.9, "virginica"], [6.5, 3.0, 5.2, 2.0, "virginica"], [6.2, 3.4, 5.4, 2.3, "virginica"], [5.9, 3.0, 5.1, 1.8, "virginica"]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": []};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</div>
</div>
</div>
<div id="8fd1bfb0" class="cell" data-execution_count="3">
<div class="cell-output cell-output-stdout">
<pre><code>There are 150 rows in this data
There are 5 columns in this data</code></pre>
</div>
</div>
<div id="a575fa44" class="cell" data-execution_count="4">
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>Species
setosa        50
versicolor    50
virginica     50
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>There are 3 total species in this dataset, with each of them having 50 entries. ### KMeans Algorithm Overview</p>
<p>K-means is an iterative clustering algorithm that aims to partition <code>n</code> observations into <code>k</code> clusters in which each observation belongs to the cluster with the nearest mean. The algorithm works as follows:</p>
<ol type="1">
<li><p>Initialization: Select k initial centroids randomly from the data points.</p></li>
<li><p>Assignment step: Assign each data point to the closest centroid. The “closeness” is typically determined by the Euclidean distance between points.</p></li>
<li><p>Update step: Recalculate the centroids as the mean of all data points assigned to that centroid’s cluster.</p></li>
<li><p>Convergence Check: Repeat the assignment and update steps until the centroids do not change significantly, or a maximum number of iterations is reached.</p></li>
</ol>
<section id="step-1---initialization" class="level4">
<h4 class="anchored" data-anchor-id="step-1---initialization">Step 1 - Initialization</h4>
<p>The initialization step is crucial in the K-means algorithm as it sets the starting point for the clusters. In this step, k initial centroids are selected randomly from the data points. The choice of initial centroids can significantly affect the final clusters and convergence speed of the algorithm. There are various strategies for choosing these centroids. My implementation randomly pick k unique data points from the dataset.</p>
<div id="95b6c98c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> initialize_centroids(X, k):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> np.random.choice(X.shape[<span class="dv">0</span>], k, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X[indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---assignment" class="level4">
<h4 class="anchored" data-anchor-id="step-2---assignment">Step 2 - Assignment</h4>
<p>During the assignment step, each data point in the dataset is assigned to the nearest centroid. “Nearest” in my implementation is defined using the Euclidean distance, although other distance metrics can also be used. This step partitions the input data into k clusters based on the minimal distance criterion.</p>
<div id="65eae0e6" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_clusters(X, centroids):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> np.zeros(<span class="bu">len</span>(X), dtype<span class="op">=</span><span class="bu">int</span>)  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate over each data point</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, point <span class="kw">in</span> <span class="bu">enumerate</span>(X):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        min_distance <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)  <span class="co"># Start with a very large number as the minimum distance</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compare distance of 'point' to each centroid</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, centroid <span class="kw">in</span> <span class="bu">enumerate</span>(centroids):</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate Euclidean distance from point to centroid</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> np.sqrt(np.<span class="bu">sum</span>((point <span class="op">-</span> centroid) <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update label for the point if a closer centroid is found</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> distance <span class="op">&lt;</span> min_distance:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                min_distance <span class="op">=</span> distance</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                labels[i] <span class="op">=</span> idx</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> labels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---update" class="level4">
<h4 class="anchored" data-anchor-id="step-3---update">Step 3 - Update</h4>
<p>The update step recalculates the position of each centroid based on the mean of the data points assigned to each cluster. The function update_centroids(X, labels, k) computes the new centroids by taking the mean of all points labeled with each respective cluster index. This approach is vectorized, leveraging NumPy’s array operations to efficiently compute the mean for each cluster. This step is crucial for moving the centroids to the center of their respective clusters, which is key to refining the cluster assignments in subsequent iterations.</p>
<div id="b344d6c0" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_centroids(X, labels, k):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    new_centroids <span class="op">=</span> np.array([X[labels <span class="op">==</span> i].mean(axis<span class="op">=</span><span class="dv">0</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(k)])</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_centroids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---convergence-check" class="level4">
<h4 class="anchored" data-anchor-id="step-4---convergence-check">Step 4 - Convergence Check</h4>
<p>The convergence check is where you actually implement the K-means algorithm, where the algorithm iteratively performs the assignment and update steps until the centroids no longer change significantly, indicating convergence, or until a specified maximum number of iterations is reached.</p>
<div id="123b26fd" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> k_means(X, k, max_iters<span class="op">=</span><span class="dv">10</span>, plot <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    centroids <span class="op">=</span> initialize_centroids(X, k)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_iters):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> assign_clusters(X, centroids)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        new_centroids <span class="op">=</span> update_centroids(X, labels, k)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> plot:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            plot_clusters(X, new_centroids, labels, title <span class="op">=</span> <span class="ss">f"Iteration </span><span class="sc">{</span><span class="bu">int</span>(_<span class="op">+</span><span class="dv">1</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.allclose(centroids, new_centroids):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        centroids <span class="op">=</span> new_centroids</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> centroids, labels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="k-means-implementation" class="level3">
<h3 class="anchored" data-anchor-id="k-means-implementation">K-Means Implementation</h3>
<p>Since the Iris dataset have 3 distinct species, I will cluster the data into 3 groups. Below is the visualization of the algorithm as it computes the clusters</p>
<div id="5f0e3e7f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>centroids, labels <span class="op">=</span> k_means(X, k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-1.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-2.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-3.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-4.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-5.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-6.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-12-output-7.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As seen above, the K means cluster converged after iteration 6, meaning that the positions of the centroids did not change significantly from the previous iteration. This convergence indicates that the algorithm has found a stable clustering of the data where further iterations would not lead to any further significant changes in the positions of the centroids.</p>
</section>
<section id="comparing-with-sklearn-k-means" class="level3">
<h3 class="anchored" data-anchor-id="comparing-with-sklearn-k-means">Comparing with Sklearn K-Means</h3>
<p>Below shows the implementation of Sklearn’s K-Means:</p>
<div id="0cc2d60f" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sklearn_kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>sklearn_kmeans.fit(X)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>sklearn_labels <span class="op">=</span> sklearn_kmeans.labels_</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>sklearn_centroids <span class="op">=</span> sklearn_kmeans.cluster_centers_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the final cluster is shown below:</p>
<div id="60dbaaac" class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-14-output-1.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And this is the final cluster from my own K-means algorithm:</p>
<div id="f7be689d" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-15-output-1.png" width="589" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As seen above, the clustering are very similar.</p>
<p>Note: This is with np.random.seed set to 42, with a different seed, it is likely to get different clustering results.</p>
</section>
<section id="within---cluster-sum-of-squares-and-silhouette-scores" class="level3">
<h3 class="anchored" data-anchor-id="within---cluster-sum-of-squares-and-silhouette-scores">Within - Cluster Sum of Squares and Silhouette Scores</h3>
<p>For this portion, I will be computing both with my own custom function.</p>
<p>The WCSS and Silhouette Scores as the number of clusters increase is shown below:</p>
<div id="a660c551" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw5_questions_files/figure-html/cell-16-output-1.png" width="1333" height="564" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analysis" class="level3">
<h3 class="anchored" data-anchor-id="analysis">Analysis</h3>
<ul>
<li><p>WCSS (Within-Cluster Sum of Squares): The WCSS decreases as the number of clusters increases. This plot also shows a potential elbow around k=3, indicating that adding more clusters beyond this point results in diminishing returns in terms of WCSS reduction.</p></li>
<li><p>Silhouette Score: This metric peaks noticeably at k=2, suggesting that the clusters are most distinct and well-separated at this point. The silhouette scores for higher values of k are lower, indicating less optimal clustering in terms of inter-cluster separation and intra-cluster cohesion.</p></li>
</ul>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>Both the Within-Cluster Sum of Squares (WCSS) and the Silhouette Score provide valuable insights into the optimal number of clusters for the Iris dataset. The WCSS shows a clear elbow at k = 3, suggesting that increasing the number of clusters beyond three leads to diminishing returns in terms of variance reduction. On the other hand, the Silhouette Score peaks at k = 2, indicating excellent separation and cohesion at two clusters.</p>
<p>However, given the context of the Iris dataset, which comprises three distinct species, opting for three clusters is particularly meaningful. This choice not only aligns with the natural divisions in the data but also matches the biological expectation, thereby providing a scientifically coherent clustering solution.</p>
</section>
</section>
<section id="latent-class-mnl" class="level2">
<h2 class="anchored" data-anchor-id="latent-class-mnl">Latent-Class MNL</h2>
<p>In this portion, I explore a Latent-Class MNL model on the yogurt dataset that I used previously <a href="https://zaanis.github.io/projects/MA/hw3_questions.html">here</a>.</p>
<section id="likelihood-for-the-latent-class-multi-nomial-logit-lc-mnl-model" class="level3">
<h3 class="anchored" data-anchor-id="likelihood-for-the-latent-class-multi-nomial-logit-lc-mnl-model">Likelihood for the Latent Class Multi-nomial Logit (LC-MNL) Model</h3>
<p>In the Latent Class Multinomial Logit (LC-MNL) model, we extend the standard MNL model by incorporating latent heterogeneity among consumers. Here, instead of assuming all individuals derive utility from product characteristics in the same way, we assume there are <span class="math inline">\(K\)</span> distinct classes of consumers, each with its own unique set of preferences.</p>
<section id="model-setup" class="level4">
<h4 class="anchored" data-anchor-id="model-setup">Model Setup</h4>
<p>Let’s denote: - <span class="math inline">\(i = 1, \ldots, n\)</span>: index for consumers. - <span class="math inline">\(j = 1, \ldots, J\)</span>: index for products. - <span class="math inline">\(k = 1, \ldots, K\)</span>: index for latent classes.</p>
<p>Each consumer <span class="math inline">\(i\)</span> belongs to one latent class <span class="math inline">\(k\)</span>, but this class membership is unobserved. We assume: - Each class <span class="math inline">\(k\)</span> has its own parameter vector <span class="math inline">\(\beta_k\)</span>, reflecting distinct preferences. - <span class="math inline">\(z_{ik}\)</span> is an indicator variable that equals 1 if consumer <span class="math inline">\(i\)</span> is in class <span class="math inline">\(k\)</span> and 0 otherwise.</p>
</section>
<section id="utility-function" class="level4">
<h4 class="anchored" data-anchor-id="utility-function">Utility Function</h4>
<p>For consumer <span class="math inline">\(i\)</span> choosing product <span class="math inline">\(j\)</span> while belonging to class <span class="math inline">\(k\)</span>, the utility is given by: <span class="math display">\[ U_{ijk} = x_j' \beta_k + \epsilon_{ijk} \]</span> where <span class="math inline">\(\epsilon_{ijk}\)</span> is an i.i.d. extreme value error term, similar to the MNL model.</p>
</section>
<section id="probability-of-choice" class="level4">
<h4 class="anchored" data-anchor-id="probability-of-choice">Probability of Choice</h4>
<p>The probability that consumer <span class="math inline">\(i\)</span> in class <span class="math inline">\(k\)</span> chooses product <span class="math inline">\(j\)</span> is: <span class="math display">\[ \mathbb{P}_{ik}(j) = \frac{e^{x_j' \beta_k}}{\sum_{l=1}^J e^{x_l' \beta_k}} \]</span></p>
</section>
<section id="latent-class-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="latent-class-probabilities">Latent Class Probabilities</h4>
<p>We also model the probability that any consumer belongs to class <span class="math inline">\(k\)</span>, potentially as a function of some observed characteristics <span class="math inline">\(w_i\)</span> of the consumer: <span class="math display">\[ \pi_k(w_i; \gamma) = \frac{e^{w_i' \gamma_k}}{\sum_{m=1}^K e^{w_i' \gamma_m}} \]</span> where <span class="math inline">\(\gamma\)</span> are parameters to be estimated that influence class membership.</p>
</section>
<section id="individual-likelihood-function" class="level4">
<h4 class="anchored" data-anchor-id="individual-likelihood-function">Individual Likelihood Function</h4>
<p>The individual likelihood function for consumer <span class="math inline">\(i\)</span>, taking into account the uncertainty about class membership, is: <span class="math display">\[ L_i(\beta_1, \ldots, \beta_K; \gamma) = \sum_{k=1}^K \pi_k(w_i; \gamma) \prod_{j=1}^J \mathbb{P}_{ik}(j)^{\delta_{ij}} \]</span> Here, the likelihood is a weighted sum of the probabilities of choosing each product across all classes, weighted by the probability of belonging to each class.</p>
</section>
<section id="joint-likelihood-across-all-consumers" class="level4">
<h4 class="anchored" data-anchor-id="joint-likelihood-across-all-consumers">Joint Likelihood Across All Consumers</h4>
<p>The joint likelihood across all consumers is the product of all individual likelihoods: <span class="math display">\[ L_n(\beta_1, \ldots, \beta_K; \gamma) = \prod_{i=1}^n L_i(\beta_1, \ldots, \beta_K; \gamma) \]</span></p>
</section>
<section id="log-likelihood-function" class="level4">
<h4 class="anchored" data-anchor-id="log-likelihood-function">Log-Likelihood Function</h4>
<p>The joint log-likelihood function, which is more practical for estimation due to numerical stability, is: <span class="math display">\[ \ell_n(\beta_1, \ldots, \beta_K; \gamma) = \sum_{i=1}^n \log \left( \sum_{k=1}^K \pi_k(w_i; \gamma) \prod_{j=1}^J \mathbb{P}_{ik}(j)^{\delta_{ij}} \right) \]</span></p>
</section>
<section id="key-differences-from-mnl" class="level4">
<h4 class="anchored" data-anchor-id="key-differences-from-mnl">Key Differences from MNL</h4>
<ul>
<li><strong>Consumer Heterogeneity</strong>: LC-MNL accounts for different consumer preferences by classifying them into latent classes with distinct utility parameters.</li>
<li><strong>Complexity in Estimation</strong>: Estimation involves both the coefficients that describe how product characteristics affect utility and the parameters that govern class membership.</li>
<li><strong>Model Flexibility</strong>: LC-MNL provides a richer understanding of market segmentation and can reveal niche markets or consumer segments that might be obscured in a standard MNL model.</li>
</ul>
<p>The LC-MNL model thus offers a robust framework for understanding consumer choice behavior when there are unobserved segments in the market, each with unique preferences, which can be particularly valuable in targeted marketing and product positioning strategies. ### Estimation</p>
<p>The latent class log likelihood function I will be using is shown below:</p>
<div id="efe7e496" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_likelihood_lc(params, data, num_classes):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split params into class probabilities (in log scale for optimization) and class-specific beta coefficients</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    class_log_probs <span class="op">=</span> params[:num_classes]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    class_probs <span class="op">=</span> np.exp(class_log_probs <span class="op">-</span> np.<span class="bu">max</span>(class_log_probs))  <span class="co"># To prevent numerical overflow</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    class_probs <span class="op">/=</span> np.<span class="bu">sum</span>(class_probs)  <span class="co"># Normalize to make probabilities sum to 1</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> params[num_classes:].reshape((num_classes, <span class="dv">5</span>))  <span class="co"># Reshape into class-specific params</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    total_log_likelihood <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> betas[k]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'utility'</span>] <span class="op">=</span> (beta[<span class="dv">0</span>] <span class="op">*</span> data[<span class="st">'yogurt 1'</span>] <span class="op">+</span> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                           beta[<span class="dv">1</span>] <span class="op">*</span> data[<span class="st">'yogurt 2'</span>] <span class="op">+</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                           beta[<span class="dv">2</span>] <span class="op">*</span> data[<span class="st">'yogurt 3'</span>] <span class="op">+</span> </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                           beta[<span class="dv">3</span>] <span class="op">*</span> data[<span class="st">'featured'</span>] <span class="op">+</span> </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                           beta[<span class="dv">4</span>] <span class="op">*</span> data[<span class="st">'price'</span>])</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'exp_utility'</span>] <span class="op">=</span> np.exp(data[<span class="st">'utility'</span>])</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'sum_exp_utility'</span>] <span class="op">=</span> data.groupby(<span class="st">'id'</span>)[<span class="st">'exp_utility'</span>].transform(<span class="st">'sum'</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'probability'</span>] <span class="op">=</span> data[<span class="st">'exp_utility'</span>] <span class="op">/</span> data[<span class="st">'sum_exp_utility'</span>]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the log-likelihood for this class</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        class_log_likelihood <span class="op">=</span> data[<span class="st">'chosen'</span>] <span class="op">*</span> np.log(data[<span class="st">'probability'</span>] <span class="op">+</span> <span class="fl">1e-10</span>)  <span class="co"># Adding small number to avoid log(0)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weight by class membership probability</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        total_log_likelihood <span class="op">+=</span> class_probs[k] <span class="op">*</span> class_log_likelihood.<span class="bu">sum</span>()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>total_log_likelihood</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the function defined, I then used scipy.optimize from Python to find the beta values for the 5 parameters and for both class (only 2 latent classes). First, I initilized all the guesses as zero, then I used the minimize() fucntion from scipy.optimize to find the beta values. The values are shown below.</p>
<div id="839b425b" class="cell" data-execution_count="18">
<div class="cell-output cell-output-stdout">
<pre><code>Class Probabilities: [0.5 0.5]
Parameters for Class 1: Beta_1 = 1.38774270701392 , Beta_2 = 0.6435095665810492 , Beta_3 = -3.086085549885488 , Beta_f = 0.4874428216635878 , Beta_p = -37.05721231279164
Parameters for Class 2: Beta_1 = 1.38774270701392 , Beta_2 = 0.6435095665810492 , Beta_3 = -3.086085549885488 , Beta_f = 0.4874428216635878 , Beta_p = -37.05721231279164</code></pre>
</div>
</div>
<p>It appears that both class have the same beta values, potentially indicating indistinguishable class characterstics.</p>
</section>
</section>
<section id="comparing-to-original-mnl" class="level3">
<h3 class="anchored" data-anchor-id="comparing-to-original-mnl">Comparing to Original MNL</h3>
<p>The original parameters from the <a href="https://zaanis.github.io/projects/MA/hw3_questions.html">previous post</a> was:</p>
<p>Estimated parameters: beta_1: 1.3877520023064622</p>
<p>beta_2: 0.6435049292323878</p>
<p>beta_3: -3.0861128992213978</p>
<p>beta_f: 0.48741409137900876</p>
<p>beta_p: -37.0578717065307</p>
<p>Comparing to the latent class model, it appears that the parameters are very similar, with very slight differences only.</p>
</section>
<section id="number-of-class" class="level3">
<h3 class="anchored" data-anchor-id="number-of-class">Number of Class</h3>
<p>To determine the optimal number of latent classes to use, I fit the Latent Class Multinomial Logit (LC-MNL) model for a range of class numbers (2, 3, …, K) and evaluate each model using the Bayesian Information Criterion (BIC).</p>
<p>The BIC is a criterion for model selection among a finite set of models; the model with the lowest BIC is preferred. It is calculated as:</p>
<p><span class="math display">\[ \text{BIC} = -2 \cdot \ell + p \cdot \log(n) \]</span></p>
<p>where: - ( ) is the log-likelihood of the model. - ( p ) is the number of estimated parameters. - ( n ) is the number of observations.</p>
<p>The BIC penalizes models with more parameters to prevent overfitting, balancing model complexity with goodness of fit. By computing the BIC for models with different numbers of latent classes, we can identify the model that best explains the data without unnecessary complexity.</p>
<p>In this analysis, I fit the LC-MNL model for 2 to 7 classes and computed the BIC for each model. The results is shown below:</p>
<div id="974c2dd8" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_bic(log_likelihood, num_params, num_obs):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> log_likelihood <span class="op">+</span> num_params <span class="op">*</span> np.log(num_obs)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_lc_mnl_model(data, max_classes<span class="op">=</span><span class="dv">7</span>):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    num_obs <span class="op">=</span> data[<span class="st">'id'</span>].nunique()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    num_features <span class="op">=</span> <span class="dv">5</span>  <span class="co"># beta1, beta2, beta3, beta_f, beta_p</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    params_values <span class="op">=</span> {}</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    bic_values <span class="op">=</span> []</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> num_classes <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, max_classes <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        initial_params <span class="op">=</span> np.zeros(num_classes <span class="op">+</span> num_classes <span class="op">*</span> num_features)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> minimize(log_likelihood_lc, initial_params, args<span class="op">=</span>(data, num_classes), method<span class="op">=</span><span class="st">'L-BFGS-B'</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.success:</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            log_likelihood <span class="op">=</span> <span class="op">-</span>result.fun</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            num_params <span class="op">=</span> num_classes <span class="op">+</span> num_classes <span class="op">*</span> num_features</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            bic <span class="op">=</span> calculate_bic(log_likelihood, num_params, num_obs)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            bic_values.append((num_classes, bic))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            params_values[num_classes] <span class="op">=</span> result.x</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Classes: </span><span class="sc">{</span>num_classes<span class="sc">}</span><span class="ss"> failed to converge."</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bic_values, params_values</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>bic_values, params_values <span class="op">=</span> fit_lc_mnl_model(yogurt_data)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>optimal_num_classes <span class="op">=</span> <span class="bu">min</span>(bic_values, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>bic_values, optimal_num_classes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>([(2, 5410.661151614784),
  (3, 5457.435030869445),
  (4, 5504.208910339281),
  (5, 5550.982793386074),
  (6, 5597.756673529305),
  (7, 5644.530552820768)],
 (2, 5410.661151614784))</code></pre>
</div>
</div>
<p>The results indicate that the model with 2 latent classes has the lowest BIC value, suggesting it is the optimal number of classes for our dataset.</p>
<p>Below are the optimal parameters:</p>
<div id="8e161455" class="cell" data-execution_count="20">
<div class="cell-output cell-output-stdout">
<pre><code>Optimal number of classes: 2
Class 1 Probabilities: 0.5
Parameters for Class 1:
  Beta_1 = 1.38774270701392
  Beta_2 = 0.6435095665810492
  Beta_3 = -3.086085549885488
  Beta_f = 0.4874428216635878
  Beta_p = -37.05721231279164

Class 2 Probabilities: 0.5
Parameters for Class 2:
  Beta_1 = 1.38774270701392
  Beta_2 = 0.6435095665810492
  Beta_3 = -3.086085549885488
  Beta_f = 0.4874428216635878
  Beta_p = -37.05721231279164
</code></pre>
</div>
</div>
</section>
<section id="discussion" class="level3">
<h3 class="anchored" data-anchor-id="discussion">Discussion</h3>
<p>From the beta intercept values, it appears that for both class:</p>
<ol type="1">
<li>Yogust 1 is the most preferred as (<span class="math inline">\(\beta_1\)</span>) has the largest positive value</li>
<li>Yogurt 2 is also second most preferred as (<span class="math inline">\(\beta_2\)</span>) is also positive. However, it is less preferred compared to Yogurt 1</li>
<li>Yogurt 3 is the least preferred, as suggested by the negative (<span class="math inline">\(\beta_3\)</span>)</li>
<li>Yogurt 4 is third preferred. As it is the base comparison and there are 2 yogurts with positive coefficients and 1 yogurt with negative coefficient, making yogurt 4 the third preferred</li>
<li>(<span class="math inline">\(\beta_f\)</span>) having a positive value of 0.487 indicates that featuring a yogurt increases its utility and thus its chance of being selected</li>
<li>(<span class="math inline">\(\beta_p\)</span>) having a large negative value of 37.057 indicates higher prices reduces the chance of a yogurt being selected</li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>